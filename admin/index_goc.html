<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Digital Tools and Code Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Thêm thư viện SheetJS để xuất Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #1abc9c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .logo i {
            font-size: 2.5rem;
            margin-right: 10px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .admin-info {
            text-align: center;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: var(--primary-color);
            font-size: 2rem;
        }

        .admin-info h2 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .admin-info p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .sidebar-menu {
            flex: 1;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: white;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: white;
        }

        .menu-item i {
            font-size: 1.2rem;
            margin-right: 15px;
            width: 24px;
            text-align: center;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            margin: 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .logout-btn i {
            margin-right: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            position: relative;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: white;
            color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #f1f1f1;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        /* Admin Content */
        .admin-content {
            padding: 40px 0;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-right: 15px;
        }

        .stat-icon.primary {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .stat-icon.success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .stat-icon.warning {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .stat-info p {
            color: #777;
            font-size: 0.9rem;
        }

        .content-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--dark-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: var(--dark-color);
        }

        tr:hover {
            background-color: #f5f7fa;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.active {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .status.banned {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .status.pending {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .status.completed {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }

        .btn-edit {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .btn-ban {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .btn-add-funds {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .btn-approve {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }

        .btn-reject {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .btn-delete {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .btn-export {
            background-color: rgba(155, 89, 182, 0.1);
            color: #9b59b6;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            margin: auto;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            color: #777;
            background: none;
            border: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Notification */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .notification {
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            animation: slideInRight 0.3s ease, fadeOut 0.5s ease 4.5s forwards;
            position: relative;
            overflow: hidden;
            background-color: white;
            border-left: 5px solid var(--primary-color);
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification-icon {
            margin-right: 15px;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .notification.success .notification-icon {
            color: var(--success-color);
        }

        .notification.error .notification-icon {
            color: var(--danger-color);
        }

        .notification.warning .notification-icon {
            color: var(--warning-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .close-notification {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            margin-left: 10px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: visible;
            }
            
            .logo h1, .admin-info, .menu-item span {
                display: none;
            }
            
            .logo {
                justify-content: center;
                padding: 15px 0;
            }
            
            .menu-item {
                justify-content: center;
                padding: 15px 0;
            }
            
            .menu-item i {
                margin-right: 0;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .logout-btn span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                bottom: 0;
                top: auto;
                flex-direction: row;
                padding: 0;
            }
            
            .logo, .admin-info, .logout-btn {
                display: none;
            }
            
            .sidebar-menu {
                display: flex;
                width: 100%;
                justify-content: space-around;
            }
            
            .menu-item {
                flex-direction: column;
                padding: 10px 5px;
                font-size: 0.7rem;
                border-left: none;
                border-top: 4px solid transparent;
            }
            
            .menu-item:hover, .menu-item.active {
                border-left-color: transparent;
                border-top-color: white;
            }
            
            .menu-item i {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 1.2rem;
            }
            
            .menu-item span {
                display: block;
            }
            
            .main-content {
                margin-left: 0;
                margin-bottom: 60px;
            }

            .section-actions {
                flex-direction: column;
                align-items: flex-end;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Export buttons container */
        .export-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-code"></i>
            <h1>Admin Panel</h1>
        </div>

        <div class="admin-info">
            <div class="admin-avatar">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2 id="admin-name">Administrator</h2>
            <p id="admin-email">admin@example.com</p>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Trang Quản Trị</span>
            </div>
            <div class="menu-item" data-page="users">
                <i class="fas fa-users"></i>
                <span>Quản lý người dùng</span>
            </div>
            <div class="menu-item" data-page="products">
                <i class="fas fa-box"></i>
                <span>Quản lý sản phẩm</span>
            </div>
            <div class="menu-item" data-page="services">
                <i class="fas fa-gift"></i>
                <span>Dịch vụ miễn phí</span>
            </div>
            <div class="menu-item" data-page="deposits">
                <i class="fas fa-money-bill-wave"></i>
                <span>Yêu cầu nộp tiền</span>
            </div>
            <div class="menu-item" data-page="transactions">
                <i class="fas fa-history"></i>
                <span>Lịch Sử Giao Dịch</span>
            </div>
            <div class="menu-item" data-page="stats">
                <i class="fas fa-chart-bar"></i>
                <span>Thống Kê</span>
            </div>
        </div>

        <div class="logout-btn" id="logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Đăng xuất</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-code"></i>
                        <h1>Digital Code Store - Admin</h1>
                    </div>
                    <div class="admin-actions">
                        <button class="btn btn-primary" onclick="window.location.href='trangchu.html'">
                            <i class="fas fa-home"></i> Về trang chủ
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Content -->
        <div class="container admin-content">
            <!-- Dashboard Page -->
            <div class="content-section active" id="dashboard-page">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-users">0</h3>
                            <p>Tổng số người dùng</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-orders">0</h3>
                            <p>Tổng số đơn hàng</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-revenue">0</h3>
                            <p>Doanh thu</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="pending-deposits">0</h3>
                            <p>Yêu cầu nộp tiền chờ xử lý</p>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-title">
                        <span>Hoạt động gần đây</span>
                    </div>
                    <table id="recent-activities">
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Người dùng</th>
                                <th>Hành động</th>
                                <th>Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4">Đang tải dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Management Page -->
            <div class="content-section" id="users-page">
                <div class="section-title">
                    <span>Quản lý người dùng</span>
                    <div class="section-actions">
                        <input type="text" id="user-search" class="form-control" placeholder="Tìm kiếm theo Email hoặc ID..." style="width: 300px;">
                        <button class="btn btn-success" id="export-users-btn">
                            <i class="fas fa-file-export"></i> Xuất Excel
                        </button>
                    </div>
                </div>
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên</th>
                            <th>Email</th>
                            <th>Số dư</th>
                            <th>Vai trò</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Products Management Page -->
            <div class="content-section" id="products-page">
                <div class="section-title">
                    <span>Quản lý sản phẩm</span>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="add-product-btn">
                            <i class="fas fa-plus"></i> Thêm sản phẩm
                        </button>
                    </div>
                </div>
                <table id="products-table">
                    <thead>
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Mô tả</th>
                            <th>Giá</th>
                            <th>Nổi bật</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Free Services Management Page -->
            <div class="content-section" id="services-page">
                <div class="section-title">
                    <span>Quản lý dịch vụ miễn phí</span>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="add-service-btn">
                            <i class="fas fa-plus"></i> Thêm dịch vụ
                        </button>
                    </div>
                </div>
                <table id="services-table">
                    <thead>
                        <tr>
                            <th>Hình ảnh</th>
                            <th>Tên dịch vụ</th>
                            <th>Mô tả</th>
                            <th>URL</th>
                            <th>Nổi bật</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Deposit Requests Page -->
            <div class="content-section" id="deposits-page">
                <div class="section-title">
                    <span>Yêu cầu nộp tiền</span>
                    <div class="section-actions">
                        <input type="text" id="deposit-search" class="form-control" placeholder="Tìm kiếm theo ID người dùng..." style="width: 300px;">
                        <button class="btn btn-success" id="export-deposits-btn">
                            <i class="fas fa-file-export"></i> Xuất Excel
                        </button>
                    </div>
                </div>
                <table id="deposits-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Người dùng</th>
                            <th>Số tiền</th>
                            <th>Nội dung</th>
                            <th>Ngày yêu cầu</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Transactions Page -->
            <div class="content-section" id="transactions-page">
                <div class="section-title">
                    <span>Lịch sử giao dịch</span>
                    <div class="section-actions">
                        <input type="text" id="transaction-search" class="form-control" placeholder="Tìm kiếm theo ID người dùng..." style="width: 300px;">
                        <button class="btn btn-success" id="export-transactions-btn">
                            <i class="fas fa-file-export"></i> Xuất Excel
                        </button>
                    </div>
                </div>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Người dùng</th>
                            <th>Loại</th>
                            <th>Mô tả</th>
                            <th>Số tiền</th>
                            <th>Ngày</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Statistics Page -->
            <div class="content-section" id="stats-page">
                <div class="section-title">
                    <span>Thống kê hệ thống</span>
                </div>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="daily-revenue">0</h3>
                            <p>Doanh thu hôm nay</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="weekly-orders">0</h3>
                            <p>Đơn hàng tuần này</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="new-users">0</h3>
                            <p>Người dùng mới (7 ngày)</p>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-title">
                        <span>Top sản phẩm bán chạy</span>
                    </div>
                    <table id="top-products">
                        <thead>
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th>Số lượng bán</th>
                                <th>Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3">Đang tải dữ liệu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="edit-user-modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2>Chỉnh sửa người dùng</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label for="edit-user-name">Tên</label>
                    <input type="text" class="form-control" id="edit-user-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-user-email">Email</label>
                    <input type="email" class="form-control" id="edit-user-email" required>
                </div>
                <div class="form-group">
                    <label for="edit-user-balance">Số dư (VNĐ)</label>
                    <input type="number" class="form-control" id="edit-user-balance" required>
                </div>
                <div class="form-group">
                    <label for="edit-user-role">Vai trò</label>
                    <select class="form-control" id="edit-user-role" required>
                        <option value="user">Người dùng</option>
                        <option value="admin">Quản trị viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-user-status">Trạng thái</label>
                    <select class="form-control" id="edit-user-status" required>
                        <option value="active">Hoạt động</option>
                        <option value="banned">Bị khóa</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Lưu thay đổi</button>
            </form>
        </div>
    </div>

    <div class="modal" id="add-funds-modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2>Cộng tiền cho người dùng</h2>
            <form id="add-funds-form">
                <input type="hidden" id="add-funds-user-id">
                <div class="form-group">
                    <label for="add-funds-user-name">Người dùng</label>
                    <input type="text" class="form-control" id="add-funds-user-name" readonly>
                </div>
                <div class="form-group">
                    <label for="add-funds-amount">Số tiền (VNĐ)</label>
                    <input type="number" class="form-control" id="add-funds-amount" required min="1000">
                </div>
                <div class="form-group">
                    <label for="add-funds-description">Mô tả</label>
                    <input type="text" class="form-control" id="add-funds-description" value="Admin cộng tiền" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Cộng tiền</button>
            </form>
        </div>
    </div>

    <div class="modal" id="product-modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 id="product-modal-title">Thêm sản phẩm mới</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="product-name">Tên sản phẩm</label>
                    <input type="text" class="form-control" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-description">Mô tả</label>
                    <textarea class="form-control" id="product-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="product-price">Giá (VNĐ)</label>
                    <input type="number" class="form-control" id="product-price" required min="0">
                </div>
                <div class="form-group">
                    <label for="product-image">URL hình ảnh</label>
                    <input type="url" class="form-control" id="product-image" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label for="product-downloadUrl">URL tải xuống</label>
                    <input type="url" class="form-control" id="product-downloadUrl" placeholder="https://example.com/download" required>
                </div>
                <div class="form-group">
                    <label for="product-isFeatured">Sản phẩm nổi bật</label>
                    <select class="form-control" id="product-isFeatured">
                        <option value="false">Không</option>
                        <option value="true">Có</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="product-status">Trạng thái</label>
                    <select class="form-control" id="product-status" required>
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Ngừng hoạt động</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Lưu sản phẩm</button>
            </form>
        </div>
    </div>

    <div class="modal" id="service-modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 id="service-modal-title">Thêm dịch vụ miễn phí</h2>
            <form id="service-form">
                <input type="hidden" id="service-id">
                <div class="form-group">
                    <label for="service-name">Tên dịch vụ</label>
                    <input type="text" class="form-control" id="service-name" required>
                </div>
                <div class="form-group">
                    <label for="service-description">Mô tả</label>
                    <textarea class="form-control" id="service-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="service-image">URL hình ảnh</label>
                    <input type="url" class="form-control" id="service-image" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label for="service-externalUrl">URL liên kết</label>
                    <input type="url" class="form-control" id="service-externalUrl" placeholder="https://example.com/service" required>
                </div>
                <div class="form-group">
                    <label for="service-isFeatured">Dịch vụ nổi bật</label>
                    <select class="form-control" id="service-isFeatured">
                        <option value="false">Không</option>
                        <option value="true">Có</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="service-status">Trạng thái</label>
                    <select class="form-control" id="service-status" required>
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Ngừng hoạt động</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Lưu dịch vụ</button>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7kY_xl-B1r6pfRlUCVcI8OcLe7rOh11g",
            authDomain: "digitalcodestore-tuquangnam.firebaseapp.com",
            projectId: "digitalcodestore-tuquangnam",
            storageBucket: "digitalcodestore-tuquangnam.firebasestorage.app",
            messagingSenderId: "226534281162",
            appId: "1:226534281162:web:9e734c1b07378efb280933",
            measurementId: "G-9V4G42XSZS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const logoutBtn = document.getElementById('logout-btn');
        const menuItems = document.querySelectorAll('.menu-item');
        const pageContents = document.querySelectorAll('.content-section');
        const usersTable = document.getElementById('users-table');
        const transactionsTable = document.getElementById('transactions-table');
        const depositsTable = document.getElementById('deposits-table');
        const productsTable = document.getElementById('products-table');
        const servicesTable = document.getElementById('services-table');
        const editUserModal = document.getElementById('edit-user-modal');
        const addFundsModal = document.getElementById('add-funds-modal');
        const productModal = document.getElementById('product-modal');
        const serviceModal = document.getElementById('service-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const addFundsForm = document.getElementById('add-funds-form');
        const productForm = document.getElementById('product-form');
        const serviceForm = document.getElementById('service-form');
        const userSearch = document.getElementById('user-search');
        const depositSearch = document.getElementById('deposit-search');
        const transactionSearch = document.getElementById('transaction-search');
        const addProductBtn = document.getElementById('add-product-btn');
        const addServiceBtn = document.getElementById('add-service-btn');
        const exportUsersBtn = document.getElementById('export-users-btn');
        const exportDepositsBtn = document.getElementById('export-deposits-btn');
        const exportTransactionsBtn = document.getElementById('export-transactions-btn');

        // Check authentication and admin role
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Check if user is admin
                db.collection('users').doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            if (userData.role !== 'admin') {
                                window.location.href = 'trangchu.html';
                            } else {
                                // User is admin, load data
                                document.getElementById('admin-name').textContent = userData.displayName || 'Administrator';
                                document.getElementById('admin-email').textContent = userData.email;
                                
                                loadStats();
                                loadUsers();
                                loadTransactions();
                                loadDepositRequests();
                                loadProductsManagement();
                                loadServicesManagement();
                                loadRecentActivities();
                                loadStatistics();
                            }
                        }
                    })
                    .catch((error) => {
                        console.error("Error checking admin status:", error);
                        window.location.href = '../login/index.html';
                    });
            } else {
                window.location.href = '../login/index.html';
            }
        });

        // Menu navigation
        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const page = item.getAttribute('data-page');
                
                // Update active menu item
                menuItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Show corresponding page
                pageContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${page}-page`).classList.add('active');
                
                // Load specific data for the page
                if (page === 'users') {
                    loadUsers(userSearch.value);
                } else if (page === 'transactions') {
                    loadTransactions(transactionSearch.value);
                } else if (page === 'deposits') {
                    loadDepositRequests(depositSearch.value);
                } else if (page === 'stats') {
                    loadStatistics();
                } else if (page === 'products') {
                    loadProductsManagement();
                } else if (page === 'services') {
                    loadServicesManagement();
                }
            });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = '../login/index.html';
            });
        });

        // Load stats
        function loadStats() {
            // Total users
            db.collection('users').get().then((snapshot) => {
                document.getElementById('total-users').textContent = snapshot.size;
            });

            // Total orders
            db.collection('orders').get().then((snapshot) => {
                document.getElementById('total-orders').textContent = snapshot.size;
            });

            // Total revenue
            db.collection('transactions')
                .where('type', '==', 'purchase')
                .where('status', '==', 'completed')
                .get()
                .then((snapshot) => {
                    let total = 0;
                    snapshot.forEach(doc => {
                        total += doc.data().amount;
                    });
                    document.getElementById('total-revenue').textContent = formatPrice(total);
                });

            // Pending deposits
            db.collection('deposit_requests')
                .where('status', '==', 'pending')
                .get()
                .then((snapshot) => {
                    document.getElementById('pending-deposits').textContent = snapshot.size;
                });
        }

        // Load users
        function loadUsers(searchTerm = '') {
            let query = db.collection('users');
            
            query.get().then((querySnapshot) => {
                const tbody = usersTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7">Không có người dùng nào</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    const userId = doc.id;
                    
                    // Filter by search term (email or user ID)
                    if (searchTerm && 
                        !user.email.toLowerCase().includes(searchTerm.toLowerCase()) && 
                        !userId.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return;
                    }
                    
                    const userRow = `
                        <tr>
                            <td>${userId.substring(0, 8)}</td>
                            <td>${user.displayName || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>${formatPrice(user.balance || 0)}</td>
                            <td>${user.role === 'admin' ? 'Quản trị viên' : 'Người dùng'}</td>
                            <td><span class="status ${user.status || 'active'}">${user.status === 'banned' ? 'Bị khóa' : 'Hoạt động'}</span></td>
                            <td>
                                <button class="action-btn btn-edit" onclick="editUser('${userId}')">Sửa</button>
                                <button class="action-btn btn-add-funds" onclick="addFunds('${userId}', '${user.displayName || user.email}')">Cộng tiền</button>
                                <button class="action-btn btn-ban" onclick="toggleUserStatus('${userId}', '${user.status || 'active'}')">
                                    ${user.status === 'banned' ? 'Mở khóa' : 'Khóa'}
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    tbody.innerHTML += userRow;
                });
                
                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="7">Không tìm thấy người dùng phù hợp</td></tr>';
                }
            }).catch((error) => {
                console.error("Error loading users:", error);
            });
        }

        // Load transactions
        function loadTransactions(userIdFilter = '') {
            let query = db.collection('transactions').orderBy('createdAt', 'desc');
            
            query.get().then((querySnapshot) => {
                const tbody = transactionsTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7">Không có giao dịch nào</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const transaction = doc.data();
                    const transactionId = doc.id;
                    
                    // Filter by user ID
                    if (userIdFilter && transaction.userId && 
                        !transaction.userId.toLowerCase().includes(userIdFilter.toLowerCase())) {
                        return;
                    }
                    
                    const transactionRow = `
                        <tr>
                            <td>${transactionId.substring(0, 8)}</td>
                            <td>${transaction.userId ? transaction.userId.substring(0, 8) : 'N/A'}</td>
                            <td>${getTransactionTypeText(transaction.type)}</td>
                            <td>${transaction.description || 'N/A'}</td>
                            <td>${formatPrice(transaction.amount || 0)}</td>
                            <td>${transaction.createdAt ? transaction.createdAt.toDate().toLocaleString('vi-VN') : 'N/A'}</td>
                            <td><span class="status ${transaction.status || 'completed'}">${transaction.status === 'pending' ? 'Chờ xử lý' : 'Hoàn thành'}</span></td>
                        </tr>
                    `;
                    
                    tbody.innerHTML += transactionRow;
                });
                
                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="7">Không tìm thấy giao dịch phù hợp</td></tr>';
                }
            }).catch((error) => {
                console.error("Error loading transactions:", error);
            });
        }

        // Load deposit requests
        function loadDepositRequests(userIdFilter = '') {
            let query = db.collection('deposit_requests').orderBy('createdAt', 'desc');
            
            query.get().then((querySnapshot) => {
                const tbody = depositsTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7">Không có yêu cầu nộp tiền nào</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const request = doc.data();
                    const requestId = doc.id;
                    
                    // Filter by user ID
                    if (userIdFilter && request.userId && 
                        !request.userId.toLowerCase().includes(userIdFilter.toLowerCase())) {
                        return;
                    }
                    
                    const requestRow = `
                        <tr>
                            <td>${requestId.substring(0, 8)}</td>
                            <td>${request.userId ? request.userId.substring(0, 8) : 'N/A'}</td>
                            <td>${formatPrice(request.amount || 0)}</td>
                            <td>${request.description || 'N/A'}</td>
                            <td>${request.createdAt ? request.createdAt.toDate().toLocaleString('vi-VN') : 'N/A'}</td>
                            <td><span class="status ${request.status || 'pending'}">${request.status === 'pending' ? 'Chờ xử lý' : request.status === 'approved' ? 'Đã duyệt' : 'Từ chối'}</span></td>
                            <td>
                                ${request.status === 'pending' ? `
                                    <button class="action-btn btn-approve" onclick="approveDeposit('${requestId}', '${request.userId}', ${request.amount})">Duyệt</button>
                                    <button class="action-btn btn-reject" onclick="rejectDeposit('${requestId}')">Từ chối</button>
                                ` : 'Đã xử lý'}
                            </td>
                        </tr>
                    `;
                    
                    tbody.innerHTML += requestRow;
                });
                
                if (tbody.innerHTML === '') {
                    tbody.innerHTML = '<tr><td colspan="7">Không tìm thấy yêu cầu phù hợp</td></tr>';
                }
            }).catch((error) => {
                console.error("Error loading deposit requests:", error);
            });
        }

        // Load recent activities
        function loadRecentActivities() {
            db.collection('transactions')
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    const tbody = document.querySelector('#recent-activities tbody');
                    tbody.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="4">Không có hoạt động nào gần đây</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const transaction = doc.data();
                        const transactionId = doc.id;
                        
                        const activityRow = `
                            <tr>
                                <td>${transaction.createdAt ? transaction.createdAt.toDate().toLocaleString('vi-VN') : 'N/A'}</td>
                                <td>${transaction.userId ? transaction.userId.substring(0, 8) : 'N/A'}</td>
                                <td>${getTransactionTypeText(transaction.type)}</td>
                                <td>${transaction.description || 'N/A'}</td>
                            </tr>
                        `;
                        
                        tbody.innerHTML += activityRow;
                    });
                }).catch((error) => {
                    console.error("Error loading recent activities:", error);
                });
        }

        // Load statistics
        function loadStatistics() {
            // Daily revenue
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            db.collection('transactions')
                .where('type', '==', 'purchase')
                .where('status', '==', 'completed')
                .where('createdAt', '>=', today)
                .get()
                .then((snapshot) => {
                    let total = 0;
                    snapshot.forEach(doc => {
                        total += doc.data().amount;
                    });
                    document.getElementById('daily-revenue').textContent = formatPrice(total);
                });

            // Weekly orders
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            db.collection('orders')
                .where('createdAt', '>=', weekAgo)
                .get()
                .then((snapshot) => {
                    document.getElementById('weekly-orders').textContent = snapshot.size;
                });

            // New users (7 days)
            db.collection('users')
                .where('createdAt', '>=', weekAgo)
                .get()
                .then((snapshot) => {
                    document.getElementById('new-users').textContent = snapshot.size;
                });

            // Top products
            db.collection('orders')
                .get()
                .then((snapshot) => {
                    const productSales = {};
                    
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        if (order.productId) {
                            if (productSales[order.productId]) {
                                productSales[order.productId].quantity += 1;
                                productSales[order.productId].revenue += order.amount;
                            } else {
                                productSales[order.productId] = {
                                    name: order.productName || 'Sản phẩm',
                                    quantity: 1,
                                    revenue: order.amount
                                };
                            }
                        }
                    });
                    
                    // Sort by revenue
                    const sortedProducts = Object.values(productSales).sort((a, b) => b.revenue - a.revenue);
                    
                    const tbody = document.querySelector('#top-products tbody');
                    tbody.innerHTML = '';
                    
                    if (sortedProducts.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3">Không có dữ liệu bán hàng</td></tr>';
                        return;
                    }
                    
                    sortedProducts.slice(0, 5).forEach(product => {
                        const productRow = `
                            <tr>
                                <td>${product.name}</td>
                                <td>${product.quantity}</td>
                                <td>${formatPrice(product.revenue)}</td>
                            </tr>
                        `;
                        
                        tbody.innerHTML += productRow;
                    });
                });
        }

        // Load products management
        function loadProductsManagement() {
            const tbody = productsTable.querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="7">Đang tải dữ liệu...</td></tr>';

            db.collection('products').orderBy('createdAt', 'desc').get()
                .then((querySnapshot) => {
                    tbody.innerHTML = '';
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="7">Không có sản phẩm nào.</td></tr>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const product = doc.data();
                        const productId = doc.id;
                        
                        const productRow = `
                            <tr>
                                <td><img src="${product.imageUrl || 'https://via.placeholder.com/50x50?text=No+Image'}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                                <td>${product.name}</td>
                                <td>${product.description || 'N/A'}</td>
                                <td>${formatPrice(product.price)}</td>
                                <td>${product.isFeatured ? 'Có' : 'Không'}</td>
                                <td><span class="status ${product.status}">${product.status === 'active' ? 'Hoạt động' : 'Ngừng hoạt động'}</span></td>
                                <td>
                                    <button class="action-btn btn-edit" onclick="editProduct('${productId}')">Sửa</button>
                                    <button class="action-btn btn-ban" onclick="toggleProductStatus('${productId}', '${product.status}')">
                                        ${product.status === 'active' ? 'Ẩn' : 'Hiện'}
                                    </button>
                                    <button class="action-btn btn-delete" onclick="deleteProduct('${productId}', '${product.name}')">
                                        Xóa
                                    </button>
                                </td>
                            </tr>
                        `;
                        
                        tbody.innerHTML += productRow;
                    });
                })
                .catch((error) => {
                    console.error("Error loading products:", error);
                    tbody.innerHTML = '<tr><td colspan="7">Có lỗi xảy ra khi tải danh sách sản phẩm.</td></tr>';
                });
        }

        // Load services management
        function loadServicesManagement() {
            const tbody = servicesTable.querySelector('tbody');
            tbody.innerHTML = '<tr><td colspan="7">Đang tải dữ liệu...</td></tr>';

            db.collection('free_services').orderBy('createdAt', 'desc').get()
                .then((querySnapshot) => {
                    tbody.innerHTML = '';
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="7">Không có dịch vụ nào.</td></tr>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const service = doc.data();
                        const serviceId = doc.id;
                        
                        const serviceRow = `
                            <tr>
                                <td><img src="${service.imageUrl || 'https://via.placeholder.com/50x50?text=No+Image'}" alt="${service.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                                <td>${service.name}</td>
                                <td>${service.description || 'N/A'}</td>
                                <td><a href="${service.externalUrl}" target="_blank">Xem liên kết</a></td>
                                <td>${service.isFeatured ? 'Có' : 'Không'}</td>
                                <td><span class="status ${service.status}">${service.status === 'active' ? 'Hoạt động' : 'Ngừng hoạt động'}</span></td>
                                <td>
                                    <button class="action-btn btn-edit" onclick="editService('${serviceId}')">Sửa</button>
                                    <button class="action-btn btn-ban" onclick="toggleServiceStatus('${serviceId}', '${service.status}')">
                                        ${service.status === 'active' ? 'Ẩn' : 'Hiện'}
                                    </button>
                                    <button class="action-btn btn-delete" onclick="deleteService('${serviceId}', '${service.name}')">
                                        Xóa
                                    </button>
                                </td>
                            </tr>
                        `;
                        
                        tbody.innerHTML += serviceRow;
                    });
                })
                .catch((error) => {
                    console.error("Error loading services:", error);
                    tbody.innerHTML = '<tr><td colspan="7">Có lỗi xảy ra khi tải danh sách dịch vụ.</td></tr>';
                });
        }

        // Edit user
        function editUser(userId) {
            db.collection('users').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const user = doc.data();
                        document.getElementById('edit-user-id').value = userId;
                        document.getElementById('edit-user-name').value = user.displayName || '';
                        document.getElementById('edit-user-email').value = user.email || '';
                        document.getElementById('edit-user-balance').value = user.balance || 0;
                        document.getElementById('edit-user-role').value = user.role || 'user';
                        document.getElementById('edit-user-status').value = user.status || 'active';
                        
                        editUserModal.style.display = 'flex';
                    }
                })
                .catch((error) => {
                    console.error("Error loading user:", error);
                    showNotification('Lỗi', 'Không thể tải thông tin người dùng', 'error');
                });
        }

        // Add funds to user
        function addFunds(userId, userName) {
            document.getElementById('add-funds-user-id').value = userId;
            document.getElementById('add-funds-user-name').value = userName;
            document.getElementById('add-funds-amount').value = '';
            
            addFundsModal.style.display = 'flex';
        }

        // Toggle user status
        function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'banned' ? 'active' : 'banned';
            
            db.collection('users').doc(userId).update({
                status: newStatus
            })
            .then(() => {
                showNotification('Thành công', `Đã ${newStatus === 'banned' ? 'khóa' : 'mở khóa'} người dùng`, 'success');
                loadUsers(userSearch.value);
            })
            .catch((error) => {
                console.error("Error updating user status:", error);
                showNotification('Lỗi', 'Không thể cập nhật trạng thái người dùng', 'error');
            });
        }

        // Approve deposit
        function approveDeposit(requestId, userId, amount) {
            const batch = db.batch();
            
            // Update deposit request status
            const requestRef = db.collection('deposit_requests').doc(requestId);
            batch.update(requestRef, { status: 'approved' });
            
            // Update user balance
            const userRef = db.collection('users').doc(userId);
            batch.update(userRef, {
                balance: firebase.firestore.FieldValue.increment(amount)
            });
            
            // Create transaction record
            const transactionRef = db.collection('transactions').doc();
            batch.set(transactionRef, {
                userId: userId,
                type: 'deposit',
                amount: amount,
                description: 'Nạp tiền thành công',
                status: 'completed',
                createdAt: new Date()
            });
            
            // Commit batch
            batch.commit()
                .then(() => {
                    showNotification('Thành công', 'Đã duyệt yêu cầu nộp tiền', 'success');
                    loadDepositRequests(depositSearch.value);
                    loadStats();
                })
                .catch((error) => {
                    console.error("Error approving deposit:", error);
                    showNotification('Lỗi', 'Không thể duyệt yêu cầu nộp tiền', 'error');
                });
        }

        // Reject deposit
        function rejectDeposit(requestId) {
            db.collection('deposit_requests').doc(requestId).update({
                status: 'rejected'
            })
            .then(() => {
                showNotification('Thành công', 'Đã từ chối yêu cầu nộp tiền', 'success');
                loadDepositRequests(depositSearch.value);
            })
            .catch((error) => {
                console.error("Error rejecting deposit:", error);
                showNotification('Lỗi', 'Không thể từ chối yêu cầu nộp tiền', 'error');
            });
        }

        // Add product
        function addProduct() {
            document.getElementById('product-modal-title').textContent = 'Thêm sản phẩm mới';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-status').value = 'active';
            document.getElementById('product-isFeatured').value = 'false';
            productModal.style.display = 'flex';
        }

        // Edit product
        function editProduct(productId) {
            db.collection('products').doc(productId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const product = doc.data();
                        document.getElementById('product-modal-title').textContent = 'Sửa sản phẩm';
                        document.getElementById('product-id').value = productId;
                        document.getElementById('product-name').value = product.name;
                        document.getElementById('product-description').value = product.description || '';
                        document.getElementById('product-price').value = product.price;
                        document.getElementById('product-image').value = product.imageUrl || '';
                        document.getElementById('product-downloadUrl').value = product.downloadUrl || '';
                        document.getElementById('product-isFeatured').value = product.isFeatured ? 'true' : 'false';
                        document.getElementById('product-status').value = product.status || 'active';
                        
                        productModal.style.display = 'flex';
                    }
                })
                .catch((error) => {
                    console.error("Error loading product:", error);
                    showNotification('Lỗi', 'Không thể tải thông tin sản phẩm', 'error');
                });
        }

        // Add service
        function addService() {
            document.getElementById('service-modal-title').textContent = 'Thêm dịch vụ miễn phí';
            document.getElementById('service-form').reset();
            document.getElementById('service-id').value = '';
            document.getElementById('service-status').value = 'active';
            document.getElementById('service-isFeatured').value = 'false';
            serviceModal.style.display = 'flex';
        }

        // Edit service
        function editService(serviceId) {
            db.collection('free_services').doc(serviceId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const service = doc.data();
                        document.getElementById('service-modal-title').textContent = 'Sửa dịch vụ';
                        document.getElementById('service-id').value = serviceId;
                        document.getElementById('service-name').value = service.name;
                        document.getElementById('service-description').value = service.description || '';
                        document.getElementById('service-image').value = service.imageUrl || '';
                        document.getElementById('service-externalUrl').value = service.externalUrl || '';
                        document.getElementById('service-isFeatured').value = service.isFeatured ? 'true' : 'false';
                        document.getElementById('service-status').value = service.status || 'active';
                        
                        serviceModal.style.display = 'flex';
                    }
                })
                .catch((error) => {
                    console.error("Error loading service:", error);
                    showNotification('Lỗi', 'Không thể tải thông tin dịch vụ', 'error');
                });
        }

        // Toggle product status
        function toggleProductStatus(productId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            db.collection('products').doc(productId).update({
                status: newStatus
            })
            .then(() => {
                showNotification('Thành công', `Đã ${newStatus === 'active' ? 'kích hoạt' : 'ẩn'} sản phẩm thành công`, 'success');
                loadProductsManagement();
            })
            .catch((error) => {
                console.error("Error updating product status:", error);
                showNotification('Lỗi', 'Không thể cập nhật trạng thái sản phẩm', 'error');
            });
        }

        // Toggle service status
        function toggleServiceStatus(serviceId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            db.collection('free_services').doc(serviceId).update({
                status: newStatus
            })
            .then(() => {
                showNotification('Thành công', `Đã ${newStatus === 'active' ? 'kích hoạt' : 'ẩn'} dịch vụ thành công`, 'success');
                loadServicesManagement();
            })
            .catch((error) => {
                console.error("Error updating service status:", error);
                showNotification('Lỗi', 'Không thể cập nhật trạng thái dịch vụ', 'error');
            });
        }

        // Delete product
        function deleteProduct(productId, productName) {
            if (confirm(`Bạn có chắc chắn muốn xóa sản phẩm "${productName}"?`)) {
                db.collection('products').doc(productId).delete()
                .then(() => {
                    showNotification('Thành công', 'Đã xóa sản phẩm thành công', 'success');
                    loadProductsManagement();
                })
                .catch((error) => {
                    console.error("Error deleting product:", error);
                    showNotification('Lỗi', 'Không thể xóa sản phẩm', 'error');
                });
            }
        }

        // Delete service
        function deleteService(serviceId, serviceName) {
            if (confirm(`Bạn có chắc chắn muốn xóa dịch vụ "${serviceName}"?`)) {
                db.collection('free_services').doc(serviceId).delete()
                .then(() => {
                    showNotification('Thành công', 'Đã xóa dịch vụ thành công', 'success');
                    loadServicesManagement();
                })
                .catch((error) => {
                    console.error("Error deleting service:", error);
                    showNotification('Lỗi', 'Không thể xóa dịch vụ', 'error');
                });
            }
        }

        // Export users to Excel
        function exportUsersToExcel() {
            const tbody = usersTable.querySelector('tbody');
            if (tbody.innerHTML.includes('Đang tải')) {
                showNotification('Thông báo', 'Vui lòng chờ dữ liệu tải xong', 'warning');
                return;
            }

            const data = [];
            const headers = ['ID', 'Tên', 'Email', 'Số dư', 'Vai trò', 'Trạng thái'];
            
            // Add headers
            data.push(headers);
            
            // Add data rows
            const rows = usersTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length >= 6) { // Make sure we have enough columns
                    const rowData = [
                        cols[0].textContent,
                        cols[1].textContent,
                        cols[2].textContent,
                        cols[3].textContent,
                        cols[4].textContent,
                        cols[5].textContent
                    ];
                    data.push(rowData);
                }
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Người dùng');
            
            // Export to file
            XLSX.writeFile(wb, 'danh_sach_nguoi_dung.xlsx');
            showNotification('Thành công', 'Đã xuất danh sách người dùng thành công', 'success');
        }

        // Export deposits to Excel
        function exportDepositsToExcel() {
            const tbody = depositsTable.querySelector('tbody');
            if (tbody.innerHTML.includes('Đang tải')) {
                showNotification('Thông báo', 'Vui lòng chờ dữ liệu tải xong', 'warning');
                return;
            }

            const data = [];
            const headers = ['ID', 'Người dùng', 'Số tiền', 'Nội dung', 'Ngày yêu cầu', 'Trạng thái'];
            
            // Add headers
            data.push(headers);
            
            // Add data rows
            const rows = depositsTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length >= 6) { // Make sure we have enough columns
                    const rowData = [
                        cols[0].textContent,
                        cols[1].textContent,
                        cols[2].textContent,
                        cols[3].textContent,
                        cols[4].textContent,
                        cols[5].textContent
                    ];
                    data.push(rowData);
                }
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Yêu cầu nộp tiền');
            
            // Export to file
            XLSX.writeFile(wb, 'yeu_cau_nop_tien.xlsx');
            showNotification('Thành công', 'Đã xuất yêu cầu nộp tiền thành công', 'success');
        }

        // Export transactions to Excel
        function exportTransactionsToExcel() {
            const tbody = transactionsTable.querySelector('tbody');
            if (tbody.innerHTML.includes('Đang tải')) {
                showNotification('Thông báo', 'Vui lòng chờ dữ liệu tải xọng', 'warning');
                return;
            }

            const data = [];
            const headers = ['ID', 'Người dùng', 'Loại', 'Mô tả', 'Số tiền', 'Ngày', 'Trạng thái'];
            
            // Add headers
            data.push(headers);
            
            // Add data rows
            const rows = transactionsTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length >= 7) { // Make sure we have enough columns
                    const rowData = [
                        cols[0].textContent,
                        cols[1].textContent,
                        cols[2].textContent,
                        cols[3].textContent,
                        cols[4].textContent,
                        cols[5].textContent,
                        cols[6].textContent
                    ];
                    data.push(rowData);
                }
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Lịch sử giao dịch');
            
            // Export to file
            XLSX.writeFile(wb, 'lich_su_giao_dich.xlsx');
            showNotification('Thành công', 'Đã xuất lịch sử giao dịch thành công', 'success');
        }

        // Event listeners for forms
        editUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-user-name').value;
            const email = document.getElementById('edit-user-email').value;
            const balance = parseInt(document.getElementById('edit-user-balance').value);
            const role = document.getElementById('edit-user-role').value;
            const status = document.getElementById('edit-user-status').value;
            
            db.collection('users').doc(userId).update({
                displayName: name,
                email: email,
                balance: balance,
                role: role,
                status: status
            })
            .then(() => {
                showNotification('Thành công', 'Đã cập nhật thông tin người dùng', 'success');
                editUserModal.style.display = 'none';
                loadUsers(userSearch.value);
            })
            .catch((error) => {
                console.error("Error updating user:", error);
                showNotification('Lỗi', 'Không thể cập nhật thông tin người dùng', 'error');
            });
        });

        addFundsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('add-funds-user-id').value;
            const amount = parseInt(document.getElementById('add-funds-amount').value);
            const description = document.getElementById('add-funds-description').value;
            
            const batch = db.batch();
            
            // Update user balance
            const userRef = db.collection('users').doc(userId);
            batch.update(userRef, {
                balance: firebase.firestore.FieldValue.increment(amount)
            });
            
            // Create transaction record
            const transactionRef = db.collection('transactions').doc();
            batch.set(transactionRef, {
                userId: userId,
                type: 'admin_add',
                amount: amount,
                description: description,
                status: 'completed',
                createdAt: new Date()
            });
            
            // Commit batch
            batch.commit()
                .then(() => {
                    showNotification('Thành công', `Đã cộng ${formatPrice(amount)} vào tài khoản người dùng`, 'success');
                    addFundsModal.style.display = 'none';
                    loadUsers(userSearch.value);
                    loadStats();
                })
                .catch((error) => {
                    console.error("Error adding funds:", error);
                    showNotification('Lỗi', 'Không thể cộng tiền cho người dùng', 'error');
                });
        });

        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = parseInt(document.getElementById('product-price').value);
            const imageUrl = document.getElementById('product-image').value;
            const downloadUrl = document.getElementById('product-downloadUrl').value;
            const isFeatured = document.getElementById('product-isFeatured').value === 'true';
            const status = document.getElementById('product-status').value;
            
            const productData = {
                name: name,
                description: description,
                price: price,
                imageUrl: imageUrl,
                downloadUrl: downloadUrl,
                isFeatured: isFeatured,
                status: status,
                updatedAt: new Date()
            };
            
            if (productId) {
                // Update existing product
                db.collection('products').doc(productId).update(productData)
                    .then(() => {
                        showNotification('Thành công', 'Cập nhật sản phẩm thành công', 'success');
                        productModal.style.display = 'none';
                        loadProductsManagement();
                    })
                    .catch((error) => {
                        console.error("Error updating product:", error);
                        showNotification('Lỗi', 'Không thể cập nhật sản phẩm', 'error');
                    });
            } else {
                // Add new product
                productData.createdAt = new Date();
                
                db.collection('products').add(productData)
                    .then(() => {
                        showNotification('Thành công', 'Thêm sản phẩm thành công', 'success');
                        productModal.style.display = 'none';
                        loadProductsManagement();
                    })
                    .catch((error) => {
                        console.error("Error adding product:", error);
                        showNotification('Lỗi', 'Không thể thêm sản phẩm', 'error');
                    });
            }
        });

        serviceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const serviceId = document.getElementById('service-id').value;
            const name = document.getElementById('service-name').value;
            const description = document.getElementById('service-description').value;
            const imageUrl = document.getElementById('service-image').value;
            const externalUrl = document.getElementById('service-externalUrl').value;
            const isFeatured = document.getElementById('service-isFeatured').value === 'true';
            const status = document.getElementById('service-status').value;
            
            const serviceData = {
                name: name,
                description: description,
                imageUrl: imageUrl,
                externalUrl: externalUrl,
                isFeatured: isFeatured,
                status: status,
                updatedAt: new Date()
            };
            
            if (serviceId) {
                // Update existing service
                db.collection('free_services').doc(serviceId).update(serviceData)
                    .then(() => {
                        showNotification('Thành công', 'Cập nhật dịch vụ thành công', 'success');
                        serviceModal.style.display = 'none';
                        loadServicesManagement();
                    })
                    .catch((error) => {
                        console.error("Error updating service:", error);
                        showNotification('Lỗi', 'Không thể cập nhật dịch vụ', 'error');
                    });
            } else {
                // Add new service
                serviceData.createdAt = new Date();
                
                db.collection('free_services').add(serviceData)
                    .then(() => {
                        showNotification('Thành công', 'Thêm dịch vụ thành công', 'success');
                        serviceModal.style.display = 'none';
                        loadServicesManagement();
                    })
                    .catch((error) => {
                        console.error("Error adding service:", error);
                        showNotification('Lỗi', 'Không thể thêm dịch vụ', 'error');
                    });
            }
        });

        // User search
        userSearch.addEventListener('input', () => {
            loadUsers(userSearch.value);
        });

        // Deposit search
        depositSearch.addEventListener('input', () => {
            loadDepositRequests(depositSearch.value);
        });

        // Transaction search
        transactionSearch.addEventListener('input', () => {
            loadTransactions(transactionSearch.value);
        });

        // Add product button
        addProductBtn.addEventListener('click', addProduct);

        // Add service button
        addServiceBtn.addEventListener('click', addService);

        // Export buttons
        exportUsersBtn.addEventListener('click', exportUsersToExcel);
        exportDepositsBtn.addEventListener('click', exportDepositsToExcel);
        exportTransactionsBtn.addEventListener('click', exportTransactionsToExcel);

        // Close modals
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', () => {
                editUserModal.style.display = 'none';
                addFundsModal.style.display = 'none';
                productModal.style.display = 'none';
                serviceModal.style.display = 'none';
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === editUserModal) {
                editUserModal.style.display = 'none';
            }
            if (e.target === addFundsModal) {
                addFundsModal.style.display = 'none';
            }
            if (e.target === productModal) {
                productModal.style.display = 'none';
            }
            if (e.target === serviceModal) {
                serviceModal.style.display = 'none';
            }
        });

        // Utility functions
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        function getTransactionTypeText(type) {
            switch(type) {
                case 'purchase': return 'Mua hàng';
                case 'deposit': return 'Nạp tiền';
                case 'admin_add': return 'Admin cộng tiền';
                default: return type;
            }
        }

        function showNotification(title, message, type = 'info') {
            const notificationContainer = document.getElementById('notification-container');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="close-notification">&times;</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
            
            // Manual close
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.remove();
            });
        }

        // Make functions global for onclick attributes
        window.editUser = editUser;
        window.addFunds = addFunds;
        window.toggleUserStatus = toggleUserStatus;
        window.approveDeposit = approveDeposit;
        window.rejectDeposit = rejectDeposit;
        window.editProduct = editProduct;
        window.toggleProductStatus = toggleProductStatus;
        window.deleteProduct = deleteProduct;
        window.editService = editService;
        window.toggleServiceStatus = toggleServiceStatus;
        window.deleteService = deleteService;
    </script>
</body>
</html>